<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>عرض المبيعات والسلف - صالون لمسة إبداعية</title>
<style>
body {
    font-family:'Cairo',sans-serif;
    background: linear-gradient(180deg,#000,#111);
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    min-height:100vh;
    margin:0;
    padding:20px 0;
}
header {
    text-align:center;
    margin-bottom:20px;
}
header .logo-container {
    display:inline-block;
    border:4px solid gold;
    border-radius:50%;
    padding:5px;
    box-shadow:0 0 20px gold;
    margin-bottom:10px;
}
header .logo-container img {
    width:80px;
    height:80px;
    border-radius:50%;
    object-fit:cover;
}
header h1 {
    font-size:1.8rem;
    color:gold;
    margin:0;
    text-shadow:0 0 10px gold;
}
.sales-list-box {
    background:#111;
    padding:20px;
    border-radius:15px;
    box-shadow:0 0 35px rgba(255,215,0,0.5);
    width:90%;
    max-width:900px;
    text-align:center;
    display:flex;
    flex-direction:column;
    align-items:center;
}
.cards-row {
    display:flex;
    gap:10px;
    margin-bottom:15px;
    flex-wrap:wrap;
    justify-content:center;
}
.card {
    background:#222;
    padding:10px 15px;
    border-radius:10px;
    min-width:100px;
    box-shadow:0 0 10px rgba(255,215,0,0.5);
    text-align:center;
    flex:1;
}
.card h3 { margin:0 0 5px; color:gold; font-size:1rem; text-shadow:0 0 5px gold; }
.card p { margin:0; font-size:1rem; }
.filter-row {
    display:flex;
    gap:10px;
    margin-bottom:10px;
    justify-content:center;
    flex-wrap:wrap;
    align-items:center;
}
.filter-buttons {
    display:flex;
    gap:10px;
}
.filter-row input {
    padding:6px;
    border-radius:6px;
    border:none;
    background:#222;
    color:#fff;
}
.gold-btn {
    padding:6px 12px;
    border-radius:6px;
    border:none;
    background:gold;
    color:#111;
    font-weight:bold;
    cursor:pointer;
    transition:0.3s;
}
.gold-btn:hover {
    transform:translateY(-2px);
    box-shadow:0 0 15px gold;
}
.back-btn {
    align-self:flex-start;
    margin-bottom:15px;
    padding:8px 12px;
    background:gold;
    color:#111;
    font-weight:bold;
    border:none;
    border-radius:8px;
    cursor:pointer;
    transition:0.3s;
}
.back-btn:hover {
    transform:translateY(-2px);
    box-shadow:0 0 20px gold;
}
.table-section {
    width:100%;
    margin-top:15px;
}
table {
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    background:#222;
    border-radius:10px;
    overflow:hidden;
    table-layout: fixed;
}
table th, table td {
    padding:8px;
    text-align:center;
    border-bottom:1px solid #444;
    word-wrap: break-word;
}
table th { background:#333; color:gold; }
.salf-section {
    margin:15px 0;
    width:100%;
    max-width:400px;
    background:#111;
    padding:10px;
    border-radius:12px;
    display:flex;
    justify-content:center;
}
.salf-section input {
    width:60%;
    padding:8px;
    border-radius:6px;
    border:none;
    background:#222;
    color:#fff;
    margin-right:8px;
    text-align:right;
}
.salf-section button {
    padding:8px 12px;
    border-radius:6px;
    border:none;
    background:gold;
    color:#111;
    font-weight:bold;
    cursor:pointer;
}
.warning {
    color:#ffcc00;
    margin-top:8px;
    font-size:0.95rem;
}
@media(max-width:480px){
    .card { min-width:80px; font-size:0.9rem; }
    table th, table td { font-size:0.8rem; padding:4px; }
    .filter-row input, .filter-row button, .salf-section input, .salf-section button { font-size:0.85rem; padding:4px; }
    .back-btn { font-size:0.85rem; padding:6px; }
}
</style>
</head>
<body>
<div class="sales-list-box">
    <button class="back-btn" onclick="backToSales()">رجوع لتسجيل المبيعات</button>
    <header>
        <div class="logo-container"><img src="logo.jpg" alt="Logo"></div>
        <h1>عرض المبيعات والسلف</h1>
        <p id="welcomeTxt" style="margin-top:8px;color:#fff;font-size:0.95rem;"></p>
        <p id="warnTxt" class="warning" style="display:none;"></p>
    </header>

    <h2 class="section-title">إجمالي المبيعات</h2>
    <div class="cards-row">
        <div class="card"><h3>توتل اليومي</h3><p id="totalToday">0</p></div>
        <div class="card"><h3>كاش اليومي</h3><p id="cashToday">0</p></div>
        <div class="card"><h3>شبكة اليومي</h3><p id="cardToday">0</p></div>
    </div>
    <div class="cards-row">
        <div class="card"><h3>توتل الشهري</h3><p id="totalMonth">0</p></div>
        <div class="card"><h3>كاش الشهرى</h3><p id="cashMonth">0</p></div>
        <div class="card"><h3>شبكة الشهرى</h3><p id="cardMonth">0</p></div>
    </div>

    <div class="filter-row">
        <label for="startDate">من:</label>
        <input type="date" id="startDate">
        <label for="endDate">إلى:</label>
        <input type="date" id="endDate">
        <div class="filter-buttons">
            <button class="gold-btn" onclick="applyFilter()">تطبيق الفلتر</button>
            <button class="gold-btn" onclick="resetFilter()">إعادة الضبط</button>
        </div>
    </div>

    <div class="salf-section">
        <input type="number" id="salfAmount" placeholder="المبلغ">
        <button onclick="addSalf()">تسجيل السلفة</button>
    </div>

    <div class="table-section">
        <h2 class="section-title">جدول المبيعات</h2>
        <table>
            <thead>
                <tr>
                    <th>الموظف</th>
                    <th>المبلغ</th>
                    <th>طريقة الدفع</th>
                    <th>التاريخ</th>
                    <th>الوقت</th>
                </tr>
            </thead>
            <tbody id="salesTable"></tbody>
        </table>

        <h2 class="section-title">جدول السلف</h2>
        <table>
            <thead>
                <tr>
                    <th>الموظف</th>
                    <th>المبلغ</th>
                    <th>التاريخ</th>
                    <th>الوقت</th>
                </tr>
            </thead>
            <tbody id="salfTable"></tbody>
        </table>
    </div>
</div>

<script>
// ************** تحديد اسم الموظف وتمريره في الرابط **************
function getEmployeeFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('user');
}

function getEmployeeFromStorage() {
    const POSSIBLE_KEYS = ['loggedEmployee','loggedUser','username','user','logged_employee','currentUser'];
    for(const k of POSSIBLE_KEYS){
        const v = localStorage.getItem(k);
        if(v && typeof v==='string' && v.trim()!=='') return v.trim();
    }
    return null;
}

// جلب الاسم النهائي
let employeeNameRaw = getEmployeeFromURL() || getEmployeeFromStorage();
let employeeName = employeeNameRaw ? employeeNameRaw.trim() : null;

// إذا الاسم موجود في localStorage ولم يكن في الرابط، أضفه تلقائياً
if(!getEmployeeFromURL() && employeeNameRaw){
    const url = new URL(window.location);
    url.searchParams.set('user', employeeNameRaw);
    history.replaceState(null, '', url);
}

// عرض الاسم في الصفحة
document.getElementById('welcomeTxt').textContent = employeeName ? 
    'الموظف الحالي: ' + employeeName : 
    'لم يتم العثور على موظف مسجل — سيتم عرض كل السجلات';

// ************** الدوال المساعدة **************
function backToSales(){ window.location.href='employee_sales.html'; }
function formatTime12(date){let h=date.getHours(),m=date.getMinutes(),ampm=h>=12?'PM':'AM';h=h%12||12;m=m<10?'0'+m:m;return h+':'+m+' '+ampm;}
function toNumber(v){let n=parseFloat(v);return isNaN(n)?0:n;}
function getEmployeeFromRecord(rec){ return (rec.employee || rec.user || rec.username || rec.staff || '').toString(); }

// ************** تحميل الجداول **************
function loadSalesTable(filteredData=null){
    let sales = filteredData!==null ? filteredData.slice() : JSON.parse(localStorage.getItem('salesData')||'[]');
    sales = sales.filter(s => employeeName ? normalizeName(getEmployeeFromRecord(s))===normalizeName(employeeName) : true);
    const table=document.getElementById('salesTable');
    table.innerHTML='';
    sales.forEach(s=>{
        const emp=getEmployeeFromRecord(s)||'';
        const amt=toNumber(s.amount||s.price||0);
        const method=(s.method||s.payment||'').toString();
        const date=s.date||(s.datetime?s.datetime.split('T')[0]:'');
        const time=s.time||(s.datetime?s.datetime.split('T')[1]:'');
        table.innerHTML+=`<tr><td>${emp}</td><td>${amt.toFixed(2)}</td><td>${method}</td><td>${date}</td><td>${time}</td></tr>`;
    });
}

function loadSalfTable(filteredData=null){
    let salfs = filteredData!==null ? filteredData.slice() : JSON.parse(localStorage.getItem('salfData')||'[]');
    salfs = salfs.filter(s => employeeName ? normalizeName(getEmployeeFromRecord(s))===normalizeName(employeeName) : true);
    const table=document.getElementById('salfTable');
    table.innerHTML='';
    salfs.forEach(s=>{
        const amt=toNumber(s.amount||0);
        const emp=getEmployeeFromRecord(s)||'';
        const date=s.date||(s.datetime?s.datetime.split('T')[0]:'');
        const time=s.time||'';
        table.innerHTML+=`<tr><td>${emp}</td><td>${amt.toFixed(2)}</td><td>${date}</td><td>${time}</td></tr>`;
    });
}

// ************** تحميل البطاقات **************
function loadCards(){
    let sales = JSON.parse(localStorage.getItem('salesData')||'[]');
    sales = sales.filter(s => employeeName ? normalizeName(getEmployeeFromRecord(s))===normalizeName(employeeName) : true);

    let totalToday=0, cashToday=0, cardToday=0;
    let totalMonth=0, cashMonth=0, cardMonth=0;
    const today=new Date().toISOString().split('T')[0];
    const month=today.slice(0,7);

    sales.forEach(s=>{
        const amt=toNumber(s.amount||s.price||0);
        const method=(s.method||s.payment||'').toString();
        const date=s.date||(s.datetime?s.datetime.split('T')[0]:'');
        if(date===today){ totalToday+=amt; if(method.toLowerCase()==='cash') cashToday+=amt; else cardToday+=amt; }
        if((date||'').slice(0,7)===month){ totalMonth+=amt; if(method.toLowerCase()==='cash') cashMonth+=amt; else cardMonth+=amt; }
    });

    document.getElementById('totalToday').textContent=totalToday.toFixed(2);
    document.getElementById('cashToday').textContent=cashToday.toFixed(2);
    document.getElementById('cardToday').textContent=cardToday.toFixed(2);
    document.getElementById('totalMonth').textContent=totalMonth.toFixed(2);
    document.getElementById('cashMonth').textContent=cashMonth.toFixed(2);
    document.getElementById('cardMonth').textContent=cardMonth.toFixed(2);
}

// ************** فلترة التواريخ **************
function applyFilter(){
    const start=document.getElementById('startDate').value;
    const end=document.getElementById('endDate').value;
    if(!start||!end){ alert('حدد الفترة'); return; }
    const startDate=start<=end?start:end;
    const endDate=start<=end?end:start;

    let sales=JSON.parse(localStorage.getItem('salesData')||'[]');
    sales = sales.filter(s => employeeName ? normalizeName(getEmployeeFromRecord(s))===normalizeName(employeeName) : true);
    const filteredSales = sales.filter(s=>{
        const date=s.date||(s.datetime?s.datetime.split('T')[0]:'');
        return date>=startDate && date<=endDate;
    });
    loadSalesTable(filteredSales);

    let salfs=JSON.parse(localStorage.getItem('salfData')||'[]');
    salfs = salfs.filter(s => employeeName ? normalizeName(getEmployeeFromRecord(s))===normalizeName(employeeName) : true);
    const filteredSalfs=salfs.filter(s=>{
        const date=s.date||(s.datetime?s.datetime.split('T')[0]:'');
        return date>=startDate && date<=endDate;
    });
    loadSalfTable(filteredSalfs);
}

function resetFilter(){
    document.getElementById('startDate').value='';
    document.getElementById('endDate').value='';
    loadSalesTable();
    loadSalfTable();
}

// ************** تسجيل سلفة **************
function addSalf(){
    const val=document.getElementById('salfAmount').value;
    const amt=toNumber(val);
    if(amt<=0){ alert('ادخل مبلغ السلفة صحيح'); return; }

    const rawName=employeeNameRaw||'غير معروف';
    const now=new Date();
    const entry={
        employee: rawName,
        amount: amt,
        date: now.toISOString().split('T')[0],
        time: formatTime12(now),
        sentByEmployee:true
    };

    let salfs=JSON.parse(localStorage.getItem('salfData')||'[]');
    salfs.push(entry);
    localStorage.setItem('salfData', JSON.stringify(salfs));

    let withdrawals=JSON.parse(localStorage.getItem('withdrawals')||'[]');
    withdrawals.push(entry);
    localStorage.setItem('withdrawals', JSON.stringify(withdrawals));

    document.getElementById('salfAmount').value='';
    loadSalfTable();
    alert('تم تسجيل السلفة وإرسالها للمدير');
}

// ************** عند تحميل الصفحة **************
window.onload=()=>{
    loadCards();
    loadSalesTable();
    loadSalfTable();
};

// ************** تحديث تلقائي عند تغيير البيانات في localStorage **************
window.addEventListener('storage', e=>{
    if(['withdrawals','salfData','salesData'].includes(e.key) || e.key==='loggedEmployee' || e.key==='username' || e.key==='loggedUser'){
        employeeNameRaw = getEmployeeFromURL() || getEmployeeFromStorage();
        employeeName = employeeNameRaw ? employeeNameRaw.trim() : null;
        loadCards();
        loadSalesTable();
        loadSalfTable();
    }
});

// ************** دالة مساعدة **************
function normalizeName(name){ return name? name.toString().trim().toLowerCase() : ''; }
</script>
</body>
</html>
