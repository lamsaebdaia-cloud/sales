<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ملخص المبيعات - صالون لمسة إبداعية</title>
<style>
:root{
    --gold:#FFD700;
    --blue:#3498db;
    --orange:#e67e22;
    --red:#e74c3c;
    --green:#2ecc71;
    --panel:#111;
    --card-bg:#222;
    --card-text:#fff;
}

/* عام */
body{
    margin:0;
    font-family:'Cairo',sans-serif;
    background: linear-gradient(180deg,#000,#111);
    color:#fff;
    padding:20px;
}
.container{
    max-width:1200px;
    margin:0 auto;
}

/* العنوان */
header{
    text-align:center;
    margin-bottom:20px;
}
header h1{
    color:var(--gold);
    font-size:2rem;
    text-shadow:0 0 10px var(--gold);
    margin-bottom:5px;
}

/* بطاقات ملخص المحل */
.cards-row{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    justify-content:center;
    margin-bottom:20px;
    flex-direction: row-reverse;
}
.card{
    background:var(--card-bg);
    flex:1 1 180px;
    padding:20px;
    border-radius:12px;
    box-shadow:0 0 10px rgba(255,215,0,0.3);
    text-align:center;
    min-width:150px;
    transition:0.3s;
    border:2px solid var(--gold);
}
.card:hover{
    transform:translateY(-5px);
    box-shadow:0 0 25px var(--gold);
}
.card h3{
    margin:0 0 10px;
    font-size:1rem;
    text-shadow:0 0 6px var(--gold);
}
.card p{
    margin:6px 0;
    font-size:1.1rem;
    font-weight:bold;
    padding:4px 6px;
    border-radius:6px;
}

/* ألوان خاصة لكل بطاقة */
.card-summary:nth-child(1){background:var(--blue);}
.card-summary:nth-child(2){background:var(--orange);}
.card-summary:nth-child(3){background:var(--red);}
.card-summary:nth-child(4){background:var(--green);}

/* بطاقات الموظفين */
.employee-card p:nth-child(2){background:#2c3e50;}
.employee-card p:nth-child(3){background:#16a085;}
.employee-card p:nth-child(4){background:#c0392b;}
.employee-card p:nth-child(5){background:#8e44ad;}

/* فلتر وأزرار */
.filter-row{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:10px;
    margin-bottom:20px;
    flex-direction: row-reverse;
}
.filter-row input{
    padding:6px;
    border-radius:6px;
    border:none;
    background:#222;
    color:#fff;
    text-align:center;
}
.filter-buttons{
    display:flex;
    gap:10px;
    flex-direction: row-reverse;
}
.gold-btn{
    padding:6px 12px;
    border-radius:6px;
    border:none;
    background:var(--gold);
    color:#111;
    font-weight:bold;
    cursor:pointer;
}
.gold-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 0 15px var(--gold);
}

/* فلتر الموظفين */
.employee-filter{
    text-align:center;
    margin-bottom:20px;
}
.employee-filter select{
    padding:8px 12px;
    border-radius:6px;
    border:2px solid var(--gold);
    background:#222;
    color:#fff;
    font-size:16px;
    cursor:pointer;
}

/* responsive */
@media(max-width:768px){
    .cards-row{
        flex-direction:column !important;
        align-items:center;
    }
    .card{
        min-width:80%;
        margin-bottom:10px;
    }
}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>ملخص المبيعات والشهرية</h1>
    </header>

    <!-- فلتر التاريخ -->
    <div class="filter-row">
        <label for="startDate">من:</label>
        <input type="date" id="startDate">
        <label for="endDate">إلى:</label>
        <input type="date" id="endDate">
        <div class="filter-buttons">
            <button class="gold-btn" onclick="applyFilter()">تطبيق الفلتر</button>
            <button class="gold-btn" onclick="resetFilter()">إعادة الضبط</button>
            <button class="gold-btn" onclick="goBack()">رجوع للوحة التحكم</button>
        </div>
    </div>

    <!-- بطاقات ملخص المحل -->
    <div class="cards-row" id="summaryCards">
        <div class="card card-summary"><h3>إجمالي الأرادات الشهرية</h3><p id="totalMonth">0</p></div>
        <div class="card card-summary"><h3>ارادات المحل</h3><p id="halfMonth">0</p></div>
        <div class="card card-summary"><h3>المصروفات الشهرية</h3><p id="expensesMonth">0</p></div>
        <div class="card card-summary"><h3>صافي الربح النهائي</h3><p id="netProfit">0</p></div>
    </div>

    <!-- فلتر الموظفين -->
    <div class="employee-filter">
        <select id="employeeSelect" onchange="filterEmployeeCards()">
            <option value="all">عرض الجميع</option>
        </select>
    </div>

    <!-- بطاقات الموظفين -->
    <h2 style="text-align:center; margin-bottom:10px;">بطاقات الموظفين</h2>
    <div class="cards-row" id="employeeCards"></div>
</div>

<script>
// دوال مساعدة
function toNumber(v){let n=parseFloat(v);return isNaN(n)?0:n;}
function extractDateTime(record){
    let date='', time='';
    if(record.datetime){const parts=record.datetime.split('T'); date=parts[0]; if(parts[1]) time=parts[1].split('.')[0];}
    else{date=record.date||''; if(record.time){time=record.time.toString();}}
    return {date,time};
}
function getEmployeeFromRecord(rec){return (rec.employee||rec.user||rec.username||'').toString();}

// تحميل ملخص المحل
function loadSummaryCards(start=null,end=null){
    let sales = JSON.parse(localStorage.getItem('salesData')||'[]');
    let salfs = JSON.parse(localStorage.getItem('salfData')||'[]');
    let expenses = JSON.parse(localStorage.getItem('expensesData')||'[]');

    let totalMonth=0, halfMonth=0, expensesMonth=0;
    sales.forEach(s=>{
        const dt=extractDateTime(s);
        if((!start || dt.date>=start) && (!end || dt.date<=end)){
            totalMonth += toNumber(s.amount||s.price||0);
        }
    });
    expenses.forEach(e=>{
        const dt=extractDateTime(e);
        if((!start || dt.date>=start) && (!end || dt.date<=end)){
            expensesMonth += toNumber(e.amount||0);
        }
    });
    halfMonth = totalMonth/2;
    let netProfit = halfMonth - expensesMonth;

    document.getElementById('totalMonth').textContent = totalMonth.toFixed(2);
    document.getElementById('halfMonth').textContent = halfMonth.toFixed(2);
    document.getElementById('expensesMonth').textContent = expensesMonth.toFixed(2);
    document.getElementById('netProfit').textContent = netProfit.toFixed(2);
}

// تحميل بطاقات الموظفين + قائمة الأسماء
function loadEmployeeCards(start=null,end=null){
    let sales = JSON.parse(localStorage.getItem('salesData')||'[]');
    let salfs = JSON.parse(localStorage.getItem('salfData')||'[]');
    let employees = {};

    sales.forEach(s=>{
        const dt=extractDateTime(s);
        if((!start || dt.date>=start) && (!end || dt.date<=end)){
            const emp = getEmployeeFromRecord(s)||'غير معروف';
            if(!employees[emp]) employees[emp]={total:0, salf:0};
            employees[emp].total += toNumber(s.amount||s.price||0);
        }
    });
    salfs.forEach(s=>{
        const dt=extractDateTime(s);
        if((!start || dt.date>=start) && (!end || dt.date<=end)){
            const emp = getEmployeeFromRecord(s)||'غير معروف';
            if(!employees[emp]) employees[emp]={total:0, salf:0};
            employees[emp].salf += toNumber(s.amount||0);
        }
    });

    // تعبئة قائمة أسماء الموظفين
    const select = document.getElementById('employeeSelect');
    select.innerHTML = `<option value="all">عرض الجميع</option>`;
    Object.keys(employees).forEach(emp=>{
        select.innerHTML += `<option value="${emp}">${emp}</option>`;
    });

    renderEmployeeCards(employees);
}

// عرض البطاقات وفق الفلتر
function renderEmployeeCards(employees){
    const filterValue = document.getElementById('employeeSelect').value;
    const container = document.getElementById('employeeCards');
    container.innerHTML='';

    for(const emp in employees){
        if(filterValue !== "all" && filterValue !== emp) continue;

        const data = employees[emp];
        const halfTotal = data.total/2;
        const profit = halfTotal - data.salf;

        const cardHTML = `
        <div class="card employee-card" data-name="${emp}">
            <h3>${emp}</h3>
            <p>شغل الموظف: ${data.total.toFixed(2)}</p>
            <p>دخل الموظف: ${halfTotal.toFixed(2)}</p>
            <p>السلف: ${data.salf.toFixed(2)}</p>
            <p>صافى دخل الموظف: ${profit.toFixed(2)}</p>
        </div>`;
        container.insertAdjacentHTML('beforeend', cardHTML);
    }
}

// فلترة عند اختيار اسم
function filterEmployeeCards(){
    const selected = document.getElementById('employeeSelect').value;
    const cards = document.querySelectorAll('.employee-card');

    cards.forEach(card => {
        const name = card.getAttribute('data-name');
        if(selected === "all" || name === selected){
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// تطبيق فلتر التاريخ
function applyFilter(){
    const start=document.getElementById('startDate').value;
    const end=document.getElementById('endDate').value;
    loadSummaryCards(start,end);
    loadEmployeeCards(start,end);
}
function resetFilter(){
    document.getElementById('startDate').value='';
    document.getElementById('endDate').value='';
    loadSummaryCards();
    loadEmployeeCards();
}

// زر العودة
function goBack(){
    window.location.href='dashboard.html';
}

window.onload=()=>{
    loadSummaryCards();
    loadEmployeeCards();
};
</script>
</body>
</html>
